name: Continuous Deployment

on:
  push:
    branches:
      - main

env:
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: us-central1
  SERVICE_NAME: delay-api
  ARTIFACT_REGISTRY_REPO: cloud-run-images

jobs:
  deploy:
    name: Deploy to GCP Cloud Run
    runs-on: ubuntu-latest

    # Required permissions for workload identity
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Create Artifact Registry repository (if not exists)
        run: |
          gcloud artifacts repositories create ${{ env.ARTIFACT_REGISTRY_REPO }} \
            --repository-format=docker \
            --location=${{ env.GCP_REGION }} \
            --description="Docker repository for Cloud Run images" \
            || echo "Repository already exists"

      - name: Trigger Cloud Build
        run: |
          gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions=_SERVICE_NAME=${{ env.SERVICE_NAME }},_REGION=${{ env.GCP_REGION }},_ARTIFACT_REGISTRY_REPO=${{ env.ARTIFACT_REGISTRY_REPO }}

      - name: Get Cloud Run service URL
        id: get-url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Deployed to: $SERVICE_URL"

      - name: Wait for service to be ready
        run: |
          echo "Waiting for service to be ready..."
          sleep 30

      - name: Run smoke tests
        run: |
          SERVICE_URL="${{ steps.get-url.outputs.SERVICE_URL }}"

          echo "Testing health endpoint..."
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $SERVICE_URL/health)

          if [ "$HEALTH_STATUS" = "200" ]; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ùå Health check failed with status $HEALTH_STATUS"
            exit 1
          fi

          echo "Testing predict endpoint..."
          PREDICT_RESPONSE=$(curl -s -X POST "$SERVICE_URL/predict" \
            -H "Content-Type: application/json" \
            -d '{
              "flights": [
                {
                  "OPERA": "Aerolineas Argentinas",
                  "TIPOVUELO": "N",
                  "MES": 3
                }
              ]
            }')

          echo "Prediction response: $PREDICT_RESPONSE"

          if echo "$PREDICT_RESPONSE" | grep -q '"predict"'; then
            echo "‚úÖ Prediction test passed"
          else
            echo "‚ùå Prediction test failed"
            exit 1
          fi

      - name: Run stress tests
        run: |
          pip install --upgrade pip
          pip install --no-cache-dir -r requirements-test.txt
          SERVICE_URL="${{ steps.get-url.outputs.SERVICE_URL }}"

          # Run locust stress test
          mkdir -p reports
          locust -f tests/stress/api_stress.py \
            --print-stats \
            --headless \
            --users 30 \
            --spawn-rate 3 \
            --run-time 30s \
            -H $SERVICE_URL \
            --html=reports/stress-test.html

      - name: Upload stress test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stress-test-results
          path: reports/stress-test.html

      - name: Deployment summary
        if: success()
        run: |
          echo "üéâ Deployment successful!"
          echo "üåê Service URL: ${{ steps.get-url.outputs.SERVICE_URL }}"
          echo "üìä View logs: https://console.cloud.google.com/run/detail/${{ env.GCP_REGION }}/${{ env.SERVICE_NAME }}/logs"
          echo "üìà View metrics: https://console.cloud.google.com/run/detail/${{ env.GCP_REGION }}/${{ env.SERVICE_NAME }}/metrics"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo "Check logs: https://console.cloud.google.com/cloud-build/builds"
          exit 1
